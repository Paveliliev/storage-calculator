<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Storage Zone Optimizer Pro</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        :root { --bg: #f4f4f9; --card: white; --text: #2c3e50; --border: #ddd; --input-bg: white; --input-text: black; --secondary-bg: rgba(0,0,0,0.05); }
        body.dark-mode { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333; --input-bg: #2d2d2d; --input-text: #ffffff; --secondary-bg: rgba(255,255,255,0.05); }
        body.matrix-mode { --bg: #000; --card: #000; --text: #00ff41; --border: #00ff41; --input-bg: #000; --input-text: #00ff41; --secondary-bg: rgba(0,255,65,0.1); }
        
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 10px; display: flex; justify-content: center; transition: 0.3s; }
        .card { background: var(--card); padding: 15px 30px 30px 30px; border-radius: 15px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.3); width: 100%; max-width: 480px; box-sizing: border-box; }
        h1 { color: var(--text); margin-bottom: 15px; text-align: center; font-size: 1.4rem; font-weight: 600; }
        .settings-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; }
        .settings-menu { position: absolute; top: 20px; left: 20px; background: var(--card); color: var(--text); padding: 20px; border-radius: 10px; width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid var(--border); overflow-y: auto; max-height: 90vh; }
        .input-label { display: block; font-size: 0.85em; font-weight: bold; margin-bottom: 5px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--input-text); box-sizing: border-box; outline: none; }
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        button { cursor: pointer; font-weight: bold; border-radius: 8px; border: none; transition: opacity 0.2s; }
        button:hover { opacity: 0.8; }
        #calc-btn { flex: 3; padding: 12px; background-color: #007bff; color: white; }
        #copy-btn { padding: 8px 16px; background-color: #28a745; color: white; margin-top: 10px; width: 100%; display: none; }
        #reset-btn { flex: 1; padding: 12px; background-color: var(--secondary-bg); color: var(--text); border: 1px solid var(--border); }
        .res-block { background: var(--secondary-bg); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #007bff; font-size: 0.85em; line-height: 1.6; }
        .carton-res { border-left-color: #e67e22; }
        .comparison-box { margin-top: 10px; padding: 12px; border-radius: 8px; border: 1px solid #9b59b6; color: #9b59b6; background: rgba(155, 89, 182, 0.1); font-size: 0.85em; text-align: center; font-weight: bold; }
        .chart-container { margin-top: 10px; border-top: 1px solid var(--border); padding-top: 10px; }
        .bar-label { font-size: 0.75em; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .bar-bg { background: rgba(128,128,128,0.2); height: 8px; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.5s ease-out; }
        .bottleneck { font-size: 0.7em; color: #ffa500; font-style: italic; display: block; margin-top: 1px;}
    </style>
</head>
<body id="body" class="dark-mode">

    <div style="position: fixed; top: 10px; left: 10px; display: flex; gap: 5px; z-index: 50;">
        <button onclick="document.getElementById('settings-modal').style.display='block'" style="padding: 8px 12px; background: #333; color: white; border-radius: 5px;">‚öôÔ∏è</button>
        <button id="theme-toggle" onclick="handleThemeClick()" style="padding: 8px 12px; background: #333; color: white; border-radius: 5px;">üåì</button>
    </div>

    <div id="settings-modal" class="settings-overlay">
        <div class="settings-menu">
            <h3>Zone Limits</h3>
            <div style="margin-bottom:10px;"><label>SH (Shelving)</label><div class="grid-3"><input type="number" id="SH_L" value="52"><input type="number" id="SH_W" value="32"><input type="number" id="SH_H" value="30"></div></div>
            <div style="margin-bottom:10px;"><label>OC (Conveyor)</label><div class="grid-3"><input type="number" id="OC_L" value="51.5"><input type="number" id="OC_W" value="33.5"><input type="number" id="OC_H" value="34"></div></div>
            <div style="margin-bottom:10px;"><label>CL (Carton Live)</label><div class="grid-3"><input type="number" id="CL_L" value="238"><input type="number" id="CL_W" value="41.5"><input type="number" id="CL_H" value="36"></div></div>
            <button onclick="saveAndClose()" style="width:100%; padding:10px; background:#28a745; color:white; border-radius:5px;">Save & Close</button>
        </div>
    </div>

    <div class="card">
        <h1>Storage Optimizer</h1>
        <div class="input-section">
            <label class="input-label">Item Dimensions & Weight:</label>
            <div class="grid-3"><input type="number" id="L" placeholder="L"><input type="number" id="W" placeholder="W"><input type="number" id="H" placeholder="H"></div>
            <input type="number" id="Weight" placeholder="Unit Weight (kg)" style="margin-top:8px;">
        </div>

        <div style="background: var(--secondary-bg); padding: 12px; border-radius: 10px; border: 1px solid var(--border); margin-top: 15px;">
            <label class="input-label">Carton Configuration:</label>
            <div class="grid-3"><input type="number" id="CL_c" placeholder="CL"><input type="number" id="CW" placeholder="CW"><input type="number" id="CH" placeholder="CH"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                <input type="number" id="CWE" placeholder="Box kg"><input type="number" id="CQ" placeholder="Qty/Box">
            </div>
        </div>

        <div class="btn-row">
            <button id="reset-btn" py-click="reset_inputs">Reset</button>
            <button id="calc-btn" py-click="calc">Analyze Fit</button>
        </div>
        <div id="output-area" style="margin-top: 15px;"></div>
        <button id="copy-btn" onclick="copyResults()">üìã Copy Zone & Qty</button>
    </div>

    <script>
        let lastClick = 0; let clickCount = 0; let copyText = "";
        function handleThemeClick() {
            const now = Date.now();
            if (now - lastClick < 900) clickCount++; else clickCount = 1;
            lastClick = now;
            if (clickCount >= 5) { document.body.classList.toggle('matrix-mode'); clickCount = 0; } 
            else { document.body.classList.remove('matrix-mode'); document.body.classList.toggle('dark-mode'); }
        }
        function saveAndClose() {
            ["SH_L", "SH_W", "SH_H", "OC_L", "OC_W", "OC_H", "CL_L", "CL_W", "CL_H"].forEach(id => localStorage.setItem(id, document.getElementById(id).value));
            document.getElementById('settings-modal').style.display='none';
        }
        function copyResults() {
            navigator.clipboard.writeText(copyText).then(() => {
                const btn = document.getElementById('copy-btn');
                btn.innerText = "‚úÖ Copied!";
                setTimeout(() => btn.innerText = "üìã Copy Zone & Qty", 2000);
            });
        }
        window.onload = () => {
            ["SH_L", "SH_W", "SH_H", "OC_L", "OC_W", "OC_H", "CL_L", "CL_W", "CL_H"].forEach(id => {
                if(localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id);
            });
        };
    </script>

    <script type="py">
from pyscript import document, window
import math

def get_f(id):
    val = document.querySelector(f"#{id}").value
    return float(val) if val else 0.0

def reset_inputs(event):
    for i in ["L", "W", "H", "Weight", "CL_c", "CW", "CH", "CWE", "CQ"]: 
        document.querySelector(f"#{i}").value = ""
    document.querySelector("#output-area").innerHTML = ""
    document.querySelector("#copy-btn").style.display = "none"

def calc_best_fit(l, w, h, weight, zone_key, z_dims):
    z = z_dims[zone_key]
    weight_limits = {"SH": 50, "OC": 40, "CL": 80}
    
    # Best footprint (Rotation logic)
    qty1 = (math.floor(z['l']/l) * math.floor(z['w']/w))
    qty2 = (math.floor(z['l']/w) * math.floor(z['w']/l))
    footprint = max(qty1, qty2)
    
    layers = math.floor(z['h']/h)
    qty = footprint * layers
    if zone_key == "OC": qty *= 2
    
    # Weight check
    is_lim = False
    if weight > 0:
        max_w = math.floor(weight_limits[zone_key] / weight)
        if max_w < qty:
            qty, is_lim = max_w, True
            
    eff = (((l*w*h) * qty) / (z['l']*z['w']*z['h']*(2 if zone_key=="OC" else 1)) * 100) if qty > 0 else 0
    bn = "Space" if not is_lim else "Weight"
    if layers < 1: bn = "Height"
    elif footprint < 1: bn = "Footprint"
    
    return max(0, qty), eff, bn

def calc(event):
    out = document.querySelector("#output-area")
    z_dims = {
        "SH": {"l": get_f("SH_L"), "w": get_f("SH_W"), "h": get_f("SH_H")},
        "OC": {"l": get_f("OC_L"), "w": get_f("OC_W"), "h": get_f("OC_H")},
        "CL": {"l": get_f("CL_L"), "w": get_f("CL_W"), "h": get_f("CL_H")}
    }
    l, w, h, wt = get_f("L"), get_f("W"), get_f("H"), get_f("Weight")
    cl, cw, ch, cwt, cq = get_f("CL_c"), get_f("CW"), get_f("CH"), get_f("CWE"), get_f("CQ")

    if not (l and w and h): return

    # Individual Analysis
    indiv_res = {}
    html = '<div class="res-block"><strong>Individual Items:</strong>'
    for zk in ["SH", "OC", "CL"]:
        q, e, bn = calc_best_fit(l, w, h, wt, zk, z_dims)
        # Store weighted totals for comparison
        indiv_res[zk] = {"q": q, "total": q * (6 if zk=="SH" else 2 if zk=="OC" else 1), "e": e, "bn": bn}

    max_q_i = max([r['q'] for r in indiv_res.values()] + [1])
    for zk, r in indiv_res.items():
        w_pct = (r['q'] / max_q_i * 100)
        html += f'<div class="bar-label" style="margin-top:5px;"><span>{zk} ({int(r["e"])}%)</span><span>{int(r["q"])}</span></div>'
        html += f'<div class="bar-bg"><div class="bar-fill" style="width:{w_pct}%; background:#007bff;"></div></div>'
    html += '</div>'

    # Carton Analysis
    carton_best_total = 0
    if cl and cw and ch and cq:
        carton_res = {}
        html += '<div class="res-block carton-res"><strong>Carton Storage (Total Units):</strong>'
        for zk in ["SH", "OC", "CL"]:
            q_boxes, e, bn = calc_best_fit(cl, cw, ch, cwt, zk, z_dims)
            total_u = q_boxes * cq
            carton_res[zk] = {"q": total_u, "total": total_u * (6 if zk=="SH" else 2 if zk=="OC" else 1), "e": e, "bn": bn}
        
        max_q_c = max([r['q'] for r in carton_res.values()] + [1])
        for zk, r in carton_res.items():
            w_pct = (r['q'] / max_q_c * 100)
            html += f'<div class="bar-label" style="margin-top:5px;"><span>{zk} ({int(r["e"])}%)</span><span>{int(r["q"])}</span></div>'
            html += f'<div class="bar-bg"><div class="bar-fill" style="width:{w_pct}%; background:#e67e22;"></div></div>'
        html += '</div>'
        
        # Compare Best Totals
        best_indiv = max([r['total'] for r in indiv_res.values()])
        best_carton = max([r['total'] for r in carton_res.values()])
        win = "Individual" if best_indiv > best_carton else "Carton"
        diff = abs(best_indiv - best_carton)
        html += f'<div class="comparison-box">‚ú® {win} is better by {int(diff)} total units across rack!</div>'

    out.innerHTML = html
    document.querySelector("#copy-btn").style.display = "block"
    window.copyText = f"Analysis Complete. Best Mode: {win if 'win' in locals() else 'Individual'}"
    </script>
</body>
</html>
