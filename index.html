<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Storage Zone Optimizer Pro</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        :root { --bg: #f4f4f9; --card: white; --text: #2c3e50; --border: #ddd; --input-bg: white; --input-text: black; --secondary-bg: rgba(0,0,0,0.05); }
        body.dark-mode { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333; --input-bg: #2d2d2d; --input-text: #ffffff; --secondary-bg: rgba(255,255,255,0.05); }
        body.matrix-mode { --bg: #000; --card: #000; --text: #00ff41; --border: #00ff41; --input-bg: #000; --input-text: #00ff41; --secondary-bg: rgba(0,255,65,0.1); }
        
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 10px; display: flex; justify-content: center; transition: 0.3s; margin: 0; min-height: 100vh; }
        .card { background: var(--card); padding: 15px 30px 30px 30px; border-radius: 15px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.3); width: 100%; max-width: 520px; box-sizing: border-box; align-self: center; }
        h1 { color: var(--text); margin-bottom: 15px; text-align: center; font-size: 1.4rem; font-weight: 600; }
        
        .top-nav { position: fixed; top: 10px; left: 10px; display: flex; gap: 8px; z-index: 50; }
        .nav-btn { padding: 10px; background: #333; color: white; border-radius: 8px; border: 1px solid #444; font-size: 0.9rem; cursor: pointer; }
        
        /* Settings Overlay - Clickable Backdrop */
        .settings-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; cursor: pointer; }
        .settings-menu { position: absolute; top: 20px; left: 20px; background: var(--card); color: var(--text); padding: 20px; border-radius: 10px; width: 310px; border: 1px solid var(--border); cursor: default; }
        
        .input-label { display: block; font-size: 0.85em; font-weight: bold; margin-bottom: 5px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--input-text); box-sizing: border-box; outline: none; }
        
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        button { cursor: pointer; font-weight: bold; border-radius: 8px; border: none; transition: 0.2s; }
        
        #calc-btn { flex: 3; padding: 12px; background-color: #007bff; color: white; }
        #copy-btn { padding: 12px; background-color: #28a745; color: white; margin-top: 15px; width: 100%; display: none; }
        #reset-btn { flex: 1; padding: 12px; background-color: var(--secondary-bg); color: var(--text); border: 1px solid var(--border); }
        
        .res-container { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
        .res-block { background: var(--secondary-bg); padding: 12px; border-radius: 8px; border-left: 4px solid #007bff; font-size: 0.85em; line-height: 1.6; }
        .carton-res { border-left-color: #e67e22; }
        .alert-block { background: rgba(255, 77, 77, 0.1); border: 1px solid #ff4d4d; color: #ff4d4d; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.85em; }
        .comparison-box { margin-top: 10px; padding: 12px; border-radius: 8px; border: 1px solid #9b59b6; color: #9b59b6; background: rgba(155, 89, 182, 0.1); font-size: 0.9em; text-align: center; font-weight: bold; }
        .bar-label { font-size: 0.75em; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .bar-bg { background: rgba(128,128,128,0.2); height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 8px;}
        .bar-fill { height: 100%; transition: width 0.5s ease-out; }
    </style>
</head>
<body id="body" class="dark-mode">

    <div class="top-nav">
        <button class="nav-btn" onclick="document.getElementById('settings-modal').style.display='block'">‚öôÔ∏è Settings</button>
        <button id="theme-toggle" class="nav-btn" onclick="handleThemeClick()">üåì Mode</button>
    </div>

    <div id="settings-modal" class="settings-overlay" onclick="saveAndClose()">
        <div class="settings-menu" onclick="event.stopPropagation()">
            <button onclick="saveAndClose()" style="width:100%; padding:12px; background:#28a745; color:white; border-radius:5px; margin-bottom:15px;">‚úÖ Save & Close</button>
            <h3>Zone Limits</h3>
            <div style="margin-bottom:10px;"><label>SH (Shelving)</label><div class="grid-3"><input type="number" id="SH_L" value="55"><input type="number" id="SH_W" value="32"><input type="number" id="SH_H" value="30"></div></div>
            <div style="margin-bottom:10px;"><label>OC (Conveyor)</label><div class="grid-3"><input type="number" id="OC_L" value="51.5"><input type="number" id="OC_W" value="33.5"><input type="number" id="OC_H" value="34"></div></div>
            <div style="margin-bottom:20px;"><label>CL (Carton Live)</label><div class="grid-3"><input type="number" id="CL_L" value="238"><input type="number" id="CL_W" value="41.5"><input type="number" id="CL_H" value="36"></div></div>
            <hr style="border: 0; border-top: 1px solid var(--border); margin-bottom: 15px;">
            <button onclick="resetToFactory()" style="width:100%; padding:10px; background:#dc3545; color:white; border-radius:5px;">‚ö†Ô∏è Reset Factory</button>
        </div>
    </div>

    <div class="card">
        <h1>Storage Optimizer</h1>
        <div>
            <label class="input-label">Each (L/W/H/kg):</label>
            <div class="grid-3"><input type="number" id="L" placeholder="L"><input type="number" id="W" placeholder="W"><input type="number" id="H" placeholder="H"></div>
            <input type="number" id="Weight" placeholder="Each kg" style="margin-top:8px;">
        </div>

        <div style="background: var(--secondary-bg); padding: 12px; border-radius: 10px; border: 1px solid var(--border); margin-top: 15px;">
            <label class="input-label">Carton (L/W/H/kg/Qty):</label>
            <div class="grid-3"><input type="number" id="CL_c" placeholder="CL"><input type="number" id="CW" placeholder="CW"><input type="number" id="CH" placeholder="CH"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                <input type="number" id="CWE" placeholder="Box kg"><input type="number" id="CQ" placeholder="Items/Box">
            </div>
        </div>

        <div class="btn-row">
            <button id="reset-btn" py-click="reset_inputs">Reset</button>
            <button id="calc-btn" py-click="calc">Analyze Fit</button>
        </div>
        <div id="output-area"></div>
        <button id="copy-btn" onclick="copyResults()">üìã Copy Results</button>
    </div>

    <script>
        const fields = ["SH_L", "SH_W", "SH_H", "OC_L", "OC_W", "OC_H", "CL_L", "CL_W", "CL_H"];
        const factory = { "SH_L":55, "SH_W":32, "SH_H":30, "OC_L":51.5, "OC_W":33.5, "OC_H":34, "CL_L":238, "CL_W":41.5, "CL_H":36 };
        let copyText = ""; let clickCount = 0; let lastClick = 0;

        function handleThemeClick() {
            const now = Date.now();
            if (now - lastClick < 900) clickCount++; else clickCount = 1;
            lastClick = now;
            if (clickCount >= 5) { document.body.classList.toggle('matrix-mode'); clickCount = 0; } 
            else { document.body.classList.remove('matrix-mode'); document.body.classList.toggle('dark-mode'); }
        }

        function saveAndClose() {
            fields.forEach(id => localStorage.setItem(id, document.getElementById(id).value));
            document.getElementById('settings-modal').style.display='none';
        }

        function resetToFactory() {
            if(confirm("Restore defaults?")) {
                fields.forEach(id => { document.getElementById(id).value = factory[id]; localStorage.setItem(id, factory[id]); });
                document.getElementById('settings-modal').style.display='none';
            }
        }

        function copyResults() {
            navigator.clipboard.writeText(copyText).then(() => {
                const btn = document.getElementById('copy-btn');
                btn.innerText = "‚úÖ Copied!";
                setTimeout(() => btn.innerText = "üìã Copy Results", 2000);
            });
        }

        window.onload = () => {
            fields.forEach(id => { if(localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id); });
        };
    </script>

    <script type="py">
from pyscript import document, window
import math

def get_f(id):
    val = document.querySelector(f"#{id}").value
    return float(val) if val else 0.0

def reset_inputs(event):
    for i in ["L", "W", "H", "Weight", "CL_c", "CW", "CH", "CWE", "CQ"]: 
        document.querySelector(f"#{i}").value = ""
    document.querySelector("#output-area").innerHTML = ""
    document.querySelector("#copy-btn").style.display = "none"

def calc_best_fit(l, w, h, weight, zone_key, z_dims):
    z = z_dims[zone_key]
    weight_limits = {"SH": 50, "OC": 40, "CL": 80}
    
    qty1 = (math.floor(z['l']/l) * math.floor(z['w']/w))
    qty2 = (math.floor(z['l']/w) * math.floor(z['w']/l))
    footprint = max(qty1, qty2)
    layers = math.floor(z['h']/h)
    qty = footprint * layers
    
    if zone_key == "OC": qty *= 2
    if weight > 0:
        mw = math.floor(weight_limits[zone_key] / weight)
        if mw < qty: qty = mw
    
    # Efficiency Formula: $$\frac{(l \times w \times h) \times qty}{Volume_{Zone}} \times 100$$
    eff = (((l*w*h) * qty) / (z['l']*z['w']*z['h']*(2 if zone_key=="OC" else 1)) * 100) if qty > 0 else 0
    return max(0, qty), eff

def calc(event):
    out = document.querySelector("#output-area")
    z_dims = {"SH": {"l": get_f("SH_L"), "w": get_f("SH_W"), "h": get_f("SH_H")}, "OC": {"l": get_f("OC_L"), "w": get_f("OC_W"), "h": get_f("OC_H")}, "CL": {"l": get_f("CL_L"), "w": get_f("CL_W"), "h": get_f("CL_H")}}
    
    l, w, h, wt = get_f("L"), get_f("W"), get_f("H"), get_f("Weight")
    cl, cw, ch, cwt, cq = get_f("CL_c"), get_f("CW"), get_f("CH"), get_f("CWE"), get_f("CQ")
    
    if not (l and w and h): return

    html_content = ""
    
    # 1. Validation Alert
    if cl and cw and ch and cq:
        unit_vol = l * w * h
        cart_vol_per_item = (cl * cw * ch) / cq
        ratio = (cart_vol_per_item / unit_vol) * 100 if unit_vol > 0 else 0
        if ratio < 70 or ratio > 130:
            html_content += f'<div class="alert-block">‚ö†Ô∏è <b>Volume Check:</b> Carton is {int(ratio)}% of the unit volume. Possible error in dims or qty.</div>'

    # 2. Individual Calculations Block
    indiv_block = '<div class="res-block"><strong>üìä Individual Items:</strong>'
    best_indiv_total = 0
    for zk in ["SH", "OC", "CL"]:
        q, e = calc_best_fit(l, w, h, wt, zk, z_dims)
        best_indiv_total = max(best_indiv_total, q)
        indiv_block += f'<div class="bar-label"><span>{zk} ({int(e)}% Density)</span><span>{int(q)} units</span></div>'
        indiv_block += f'<div class="bar-bg"><div class="bar-fill" style="width:{e}%; background:#007bff;"></div></div>'
    indiv_block += '</div>'

    # 3. Carton Calculations Block (Only if data exists)
    cart_block = ""
    best_cart_total = 0
    if cl and cw and ch and cq:
        cart_block = '<div class="res-block carton-res"><strong>üìä Carton Storage (Units):</strong>'
        for zk in ["SH", "OC", "CL"]:
            q_boxes, e = calc_best_fit(cl, cw, ch, cwt, zk, z_dims)
            total_items = q_boxes * cq
            best_cart_total = max(best_cart_total, total_items)
            cart_block += f'<div class="bar-label"><span>{zk} ({int(e)}% Density)</span><span>{int(total_items)} items</span></div>'
            cart_block += f'<div class="bar-bg"><div class="bar-fill" style="width:{e}%; background:#e67e22;"></div></div>'
        cart_block += '</div>'

    # 4. Final Comparison
    compare_block = ""
    if cl:
        win = "Individual" if best_indiv_total >= best_cart_total else "Carton"
        diff = abs(best_indiv_total - best_cart_total)
        compare_block = f'<div class="comparison-box">‚ú® {win} storage is the winner ({int(diff)} unit difference)</div>'

    out.innerHTML = f'<div class="res-container">{indiv_block}{cart_block}</div>{compare_block}'
    window.copyText = f"Optimizer: Best Individual={best_indiv_total}, Best Carton={best_cart_total}"
    document.querySelector("#copy-btn").style.display = "block"
    </script>
</body>
</html>
